<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.12.0/d3.js"></script>
    <script src="https://dagrejs.github.io/project/dagre-d3/latest/dagre-d3.min.js"></script>
    <style>
        g.type-SELECTED>rect {
            fill: #00ffd0;
        }

        g.type-UNSELECTED>rect {
            fill: #dddd;
        }

        text {
            font-weight: 300;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 14px;
        }

        .node rect {
            stroke: #999;
            fill: #fff;
            stroke-width: 1.5px;
        }

        .edgePath path {
            stroke: #333;
            stroke-width: 1.5px;
        }

        svg {
            margin-left: 5%;
            border-style: solid;
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="sketch"></div>
        <div id="input">
            <button v-on:click="add">Add</button>
        </div>
    </div>

    <script>
        class Node {
            constructor(name, parent) {
                this.id = '_' + Math.random().toString(36).substr(2, 9);
                this.name = name
                this.parent = parent
                this.childs = {}
                if (this.parent) {
                    this.parent.addChild(this)
                }
            }

            addChild(node) {
                this.childs[node.id] = node
            }

            equals(other) {
                var thisChildIds = Object.keys(this.childs)
                var otherChildIds = Object.keys(other.childs)
                return this.id == other.id
                    &&
                    (
                        (thisChildIds.length == 0 && otherChildIds.length == 0) ||
                        (thisChildIds.length == otherChildIds.length
                            && thisChildIds.every(function (childId) {
                                return childId in other.childs && this.childs[childId].equals(other.childs[childId])
                            })
                        )
                    )
            }
        }

        var app = new Vue({
            el: '#app',
            data: {
                sketchRoot: undefined,
                nodeIndexMapping: {

                },
                nodeMapping: {

                },
                selectedNode: undefined
            },
            mounted: function () {
                this.svg = d3.select("#sketch")
                    .append('svg')
                    .attr('width', 500)
                    .attr('height', 270);


                this._initializeSketch()
            },

            methods: {
                add() {
                    var newNode = new Node("Node 2 asda dasdads ad as", this.selectedNode)
                    this._renderSketch()
                },
                _createNode(node, index) {
                    this.nodeMapping[node.id] = node
                    this.nodeIndexMapping[node.id] = index
                    this.graph.setNode(index, { label: node.name, class: "type-UNSELECTED", id: node.id });
                    if (node.parent) {
                        console.log([this._getNodeIndex(node.parent), index])
                        this.graph.setEdge(this._getNodeIndex(node.parent), index);
                    }
                },
                _initializeSketch() {
                    this.graph = new dagreD3.graphlib.Graph()
                        .setGraph({})
                        .setDefaultEdgeLabel(function () { return {}; });

                    var render = new dagreD3.render();

                    // Set up an SVG group so that we can translate the final graph.
                    this.svg = d3.select("svg")
                    this.svgGroup = this.svg.append("g");

                    this.sketchRoot = new Node("Initial", undefined)
                    this.selectedNode = this.sketchRoot
                    this._renderSketch()

                    // Run the renderer. This is what draws the final graph.

                },
                _destroySketchComponents(){
                    var g = this.graph
                    this.graph.nodes().forEach(function (v) {
                        g.removeNode(v);
                    });

                    this.graph.edges().forEach(function (v) {
                        g.removeEdge(v);
                    });
                },
                _renderSketch() {
                    if (this.sketchRoot) {
                        this._destroySketchComponents()
                        this._createNode(this.sketchRoot, 0)
                        // this.graph.setNode(0, { label: this.sketchRoot.name, class: "type-TK", id: this.sketchRoot.id });
                        // this.nodeIndexMapping[this.sketchRoot.id] = 0
                        var childs = this.sketchRoot.childs
                        var childIds = Object.keys(childs)
                        var index = 1
                        while (childIds.length > 0) {
                            newChilds = {}
                            var thisApp = this
                            childIds.forEach(function (childId) {
                                var child = childs[childId]
                                if (child) {
                                    thisApp._createNode(child, index)
                                    newChilds = { ...newChilds, ...child.childs }
                                    index++
                                }
                            })
                            childs = newChilds
                            childIds = Object.keys(childs)
                        }


                        this._roundNodeCorners()

                        var render = new dagreD3.render();
                        render(d3.select("svg g"), this.graph);

                        this._reCenterSketch()
                        this._setOnclicks()
                        this._selectNode()
                    }
                },
                _setOnclicks() {
                    var thisApp = this
                    Object.keys(this.nodeMapping).forEach(function (nodeId) {
                        d3.select("g#" + nodeId + " rect").on("click", function () {
                            thisApp._unselectNode()
                            thisApp.selectedNode = thisApp.nodeMapping[nodeId]
                            thisApp._selectNode()
                        })
                    })
                },
                _selectNode(nodeId) {
                    d3.select('g#' + this.selectedNode.id).classed('type-UNSELECTED', false).classed('type-SELECTED', true)

                },
                _unselectNode() {
                    if (this.selectedNode) {
                        d3.select('g#' + this.selectedNode.id).classed('type-SELECTED', false).classed('type-UNSELECTED', true)
                    }
                },
                _getNodeIndex(node) {
                    return this.nodeIndexMapping[node.id]
                },
                _reCenterSketch() {
                    var xCenterOffset = (this.svg.attr("width") - this.graph.graph().width) / 2;
                    this.svgGroup.attr("transform", "translate(" + xCenterOffset + ", 20)");
                    this.svg.attr("height", this.graph.graph().height + 40);
                },
                _roundNodeCorners() {
                    var g = this.graph
                    this.graph.nodes().forEach(function (v) {
                        var node = g.node(v);
                        node.rx = node.ry = 5;
                    });
                }
            }
        })
    </script>
</body>

</html>